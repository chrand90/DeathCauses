---
title: "Death causes"
output: 
    html_document:
        toc: yes
        theme: null
        template: null
        self_contained: false
        pandoc_args: ["--no-highlight"]
bibliography: references.bib
link-citations: true
---


<style type="text/css">

body{   
    background:#F0F0F0;}
    
details{
    background:#e1f9fa;}
    
.infobox{
    background:#FFFFFF;
    border: solid 2px #304b80;
    border-radius:5px;
    padding-left: 10px;
    padding-right: 10px;
    padding-top: 0px;
    padding-bottom: 0px;
    margin-right: 40px;
    margin-left: 40px;
    margin-bottom: 15px;
    margin-top: 15px;
}

</style>

# Introduction

<!-- Technical level: der er to slags læsere; 1. dem der ikke er interesseret i de matematiske detaljer, og dem der er. -->

Humanity's ability to prevent death has improved tremendously in the last 150 years. Not only can we save many more sick and injured people but we also know more about preventing illness and accidents. For example, it is well known that both drinking and smoking increase the risk of an early death while eating vegetables and wearing seatbelts, likewise, decrease the risk. It is great that people know what is good and what is bad for their health, however there is a lot more to learn. How much does the bad habits increase one's risk of death? And what types of illness and tragedies are related to each habit? On this website you can based on your specific circumstances and habits, get an estimated age of death and a breakdown of how responsible each disease or habit is for your death. These numbers are computed by our mathematical model based on results from a compiled list of [scientific papers](/model/references).

In this document we present how the mathematical model works. We try to introduce the technical terms along the way, but it is an advantage for the reader to have a strong mathematical foundation. The blue expandable sections provide extra details for readers comfortable with advanced mathematical terms.

If you are more interested in how to interpret the results on this website, you could read the page [Interpretation](/model/interpretation), which is less technical.


## Motivating example

Imagine a world where we kept track of cause of death but there was no research in their underlying causes. Furthermore, imagine that you were an old person living in a nice house in a quiet suburb and you asked the scientists to come up with an estimate of your risk of dying from homicide. Naturally, one would think that you would have less risk of dying from homicide than, say, a drug dealer. However, the scientists would not have any information about such tendencies as there is no research about the underlying cause in this hypothetical world. Therefore, their best estimate would be the crude rate; for example, in America the murder rate is 5.0 out of 100,000 per year, so the scientist would tell everyone that their chance of dying from homicide was 5/100,000=0.005% each year. Now, imagine that the scientists decided to actually do some research in the subject; they examined how many people who were murdered in their house had a gun, and compared it to how many people who weren't murdered, had guns in their house. They might find that the gun-owners had approximately 1.9 times higher risk of death from homicide in their home than non-owners (as found by the researchers @dahlberg2004guns). If our hypothetical world had a gun ownership rate of 40% of households and 50% of homicides occurring in the home (like America has today), the scientists could then give 3 different answers to the question about your risk of dying from homicide:

* If they know that your household has a gun, each year the risk of you dying from homicide is $0.00599\%$.
* If they know that your household doesn't have a gun, each year the risk of you dying from homicide is $0.00434\%$ 
* If they don't know whether your household has a gun, they have to use the default rate and say that each year your risk of dying from homicide is $0.005\%$

The formulas are explained in [Including risk factors](#including-risk-factors).

The mathematical model that we use works similarly. We start with a [neutral model] that only knows the rates of each death cause for each age. As we put more scientific results into the model, we can more accurately estimate the risks for the individual person. Finding these results is a never-ending task and a task filled with hard decisions. We have to decide which numbers to include in the model and how to combine the results. For example, what happens to your risk of homicide if you are both a drug addict and has a gun in your home? We deal with this case by case and describe our considerations in our [archive](/model#death-causes).

# The mathematical model

## The neutral model

When a user haven't filled out any personal data, the program will use the *neutral* model. For every deadly illness and accident type, the neutral model knows what proportion of the American population dies in each 5-year age bracket every year. This data comes from the [Underlying Cause of Death data set on the CDC website](https://wonder.cdc.gov/), more specifically the product @CDCreport. The illnesses and accidents are split into ICD10 codes, which is a standardized system used by doctors to classify cause of death. There are thousands of different ICD codes so we group them into sensible groups that we call *death causes*. Using this data we can compute the probability of dying from each death cause and expected age of death. In the neutral model those numbers will describe the average American, but as the user inputs more and more data, the results will be more personal. How personal it can become depends on the size and quality of our collection of risk factors and as we add more risk factors, the fact that the neutral model is American means less and less. 

<!-- #Wherever something is not explained by risk factors, the program uses the neutral model. An example is the death cause *meningitis*. Since we haven't added any risk factors for this death cause yet, the program gives everyone the same American rate of dying from it. Meningitis is an infectious disease so its occurrence depends on both place and time. the neutral probability and so many people filling out the quesThere will probably always be death causes that are hard to make more specific to the country.  where Wherever something is not specified by risk factors, the program will use the neutral model. For example we haven't included any risk factors for being killed by the police yet. This means that the reported probability of dying from meningitis is the same no matter vaccination status. This probability will be a function of the The probability tInstead it uses the average amount of alc -->

<!-- #In, but instead the    that as we includde risk factors If our collection of As we continously improve on the full model, we will betterThis also means that wherever the full model lacks any information, it will resort to the neutral model. For example, we haven't added meningitis vaccinations to the full model yet. When it computes the probability of dying from meningitis, it will therefore only use the age of  because v but bec in the distributed in the world and the vaccinations against This means If you are fully vaccinated For meningitis  Wherever the full model lacks any without personal user data the computed probabilities and expected lifetime will only describe the average American. As the user answers more questions, the program will depart from the neutral model and using the methods described in [Including risk factors](#including-risk-factors).   [det lyder ret meget som om vores model kun kan bruges på amerikanere, kan vi ikke skrive lidt om hvorfor vi synes det giver mening at bruge den generelt?]. -->

<details><summary> Formulas </summary>
For completeness, the formula that we use to compute the probability of dying from a death cause is 
$$
P(\text{die from }d)=\sum_{a=0}^{119} P(d|a) \prod_{b=0}^{a-1} \Bigl(1-\sum_{d\in D}^b P(d|a) \Bigr)
$$
where $P(d|a)$ is the probability of dying from the death cause $d$ between your $a$'th and $a+1$'th birthday. By $D$ we denote the set of all death causes. The sum goes to 119, because there is very little chance of living past 120. In the neutral model we use the proportions from the CDC as the $P(d|a)$ numbers, but when we start including risk factors we scale them using [risk ratios](#risk-ratios) or similar.
</details>

## Including risk factors

In order to compute personalized probabilities, we use *risk factors* which are different behaviors or circumstances that influence the probability of dying. 

When the scientists in our hypothetical example computed the risk of dying from homicide, they used the following formula that we will unpack. 
$$0.005\%\cdot 50\%+50\% \cdot 0.005\%\cdot \frac{1.9}{1.9\cdot 40 \%+1.0\cdot 60\%}$$
The first part $0.005\%\cdot 50\%$ is the risk of dying of homicide outside of your your home. For those $50\%$ of homicides we knew nothing about their underlying causes so we simply use their base rate of $0.005\%$. This means that we have effectively split up homicides into two sub death causes - homicides in your home with yearly rate $0.005\%\cdot 50\%=0.0025\%$ and homicides elsewhere with yearly rate $0.0025\%$. In this example the rates ($0.005\%$, $0.0025\%$) are the combined rate of Americans of all ages but in the actual model we use the rates specific to a certain age.

### Normalization factor
Looking at the more complicated part of the above equation, we are left with
$$0.0025\%\cdot \frac{1.9}{1.9\cdot 40 \%+1.0\cdot 60\%} $$
<details><summary>Derivation</summary>
Let us look at where it comes from. We know that the overall risk for homicides in the home is $0.0025\%$ and we know that the group that has a gun in their house should have 1.9 times higher risk of being murdered. This means that if the risk in the non-owner group is $x$, the risk of the gun-owner group is $x\cdot 1.9$. The question is now what $x$ is. To find $x$ we use that the overall risk is $0.0025\%$. Some of these $0.0025\%$ must come from the gun owner group. If we use the fact that $40\%$ of the population owns a gun, they would contribute with $x\cdot 1.9\cdot 40\%$ of the $0.0025\%$ and likewise the non-owners will contribute with $x\cdot1.0\cdot60\%$. In total we get an equation where we can isolate $x$.

$$
x\cdot 1.0 \cdot  60\%+x\cdot 1.9\cdot 40\%=0.0025\%
$$
$$
x \cdot (60\%+ 1.9\cdot 40\%)=0.0025\%
$$
$$
x=0.0025\%\frac{1}{1.0\cdot 60\%+ 1.9\cdot 40\%}
$$

This last equation is the formula for the risk of dying from homicide in the home for non-owners. The risk in the gun-owning group is then 
$$
x\cdot 1.9=0.0025\%\frac{1.9}{1.0\cdot 60\%+ 1.9\cdot 40\%}
$$
We have hereby shown the formulas.
</details>
$~$  
One way to think about the denominator $60\%+1.9\cdot 40\%=1.36$ is as the relative risk of dying from homicide in the home. This means that the average American is 1.36 times more likely to die from homicide in their home than an American who does not own a gun (because when we consider an average American there is a certain chance they have a gun in their home). Consequently, the fraction $1.9/1.36\approx1.397$ means that if you own a gun, you are 1.397 times more likely to die from homicide in your home than the average American. Because the rate $0.0025\%$ applies to the average American, the product $0.0025\%\cdot 1.397\approx0.0014\%$ will be the risk of dying from homicide in the home if you own a gun. Henceforth, the denominator will be called the **normalization factor**, because it scales the risks such that the overall risk is correct.

### Smoothing

Many results in health research are presented with *binned* categories. An example can be taken from @eskelinen2010caffeine, where they had examined the relation between Alzheimer's and Coffee consumption. In the their analysis they divided people into three "bins", namely people drinking 

* 0-2 cups of coffee per day,
* 3-5 cups of coffee per day, and 
* 5 or more cups of coffee per day. 

For each category they computed an [odds ratio](#odds-ratio) (that we treat as [risk ratios](#risk-ratio)). Below is the input data to our program.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
devtools::load_all("../../../Reportgeneration/DatabaseVisualization/RRtablePlotting")
dat=initialize_database("../../../death-causes-app/src/resources/Causes.json",
                        "../../../death-causes-app/src/resources/Descriptions.json")
plotSpecificPlots(dat, "Alzheimers", "Caffeine", "raw")
```

According to these numbers an average coffee consumption of 2.49 cups of coffees per day is more than twice as dangerous as drinking 2.51 cups of coffee per day. This is not realistic and only a result of the chosen binning. To get a more realistic and intuitive model, we fit a curve to binned categories.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
plotSpecificPlots(dat, "Alzheimers", "Caffeine", "interpolated")
```

This curve is computed as a trade-off between being smooth and reflecting the original data. We have decided that the above curve could not exceed 1, because there is no indication that extreme coffee consumption leads to more Alzheimer's than total coffee abstinence.

<details> <summary>Technical details</summary>
We fit the curve by finding the natural cubic splines $\{N_i\}_{i=1, \dots, n}$ that minimizes the expression
$$
\sum_{f} \frac{1}{\sigma_f^2}\biggl(RR(f)-\frac{1}{|f|}\int_f\sum_{i=1}^n N_i(X) \text{ d}X\biggr)^2+\lambda\int_f \Bigl|\sum_{i=1}^n N_i''(X)\Bigr|^2 \text{ d}X
$$
where $f$ is a binned category, $|f|$ is the size of the bin and $\lambda$ is a tuning parameter and $\sigma_f$ is the standard deviation of the [risk ratio](#risk-ratio)  $RR(f)$. The outer sum goes through only the finite bins and the natural cubic splines have knots around every finite bin. The tuning parameter $\lambda$ is chosen manually based on visual inspection of the fitted curve. 

For the $\sigma_f$-values we should remember that the estimated spline function will be multiplied with the inverse normalization factor in the program. This means that we are really making this fit for the normalized risk ratios and so we should set $\sigma_f$ equal to *their* standard deviations. They are unfortunately not easily computed and since we adjust the tuning parameter manually anyway, we mostly set $\sigma_f=1$. One exception is that many risk ratio tables have a *base category* which are used to compare against all other categories. This base category has, by construction, risk ratio 1 with standard deviation 0. In these cases we often constrain the spline to take that value (by using Lagrange multiplier method on the above expression). However, the *normalized* risk ratio of the base category does not have standard deviation 0, so the constraint does not make the computation more correct. We do it to make the resemblance between the interpolated curve and the risk ratio histogram more clear to humans.

When the input risk ratios are arranged in a multidimensional grid, we use cross products of one-dimensional splines. The basis is 
$$
\{D_k(X_i)D_l(X_j)\}_{(i,j,k,l)\in I}\cup \{D_k(X_i)\}_{(k,i)\in J}
$$
where $D_k(X_i)$ is the $k$'th spline base function of the $i$'th variable. The index set $I$ includes all combinations such that $i\neq j$ and $J$ is all combinations. Let $\mathcal{N}(X)$ be the spline of the multidimensional input $X=(X_1, \dots, X_m)$. The penalization term is then
$$
\lambda \int_f \sum_{i=1}^m\sum_{j=1}^m\biggl|\frac{\partial}{\partial X_i \partial X_j}\mathcal N(X)\biggr|^2 \text{ d}X
$$

The loss function term is the same as the in the one-dimensional case except the integral is also multidimensional. 

</details>

## Interactions between risk factors

Often there are much more than one [risk factor](#risk-factor) for a specific death cause. An example could be that both gun ownership and living in a violent household increase your risk of dying from a homicide in the home. The question is now, what happens if one does both? In other words, what is the *interaction* between household violence and gun ownership?

<details> <summary> Homicide and physical violence in the home</summary>
The researchers @kellermann1993gun found that the odds of dying from homicide was $4.4$ times higher if there had ever been a fight where someone was physically hurt in the home. In the same process they found that $5.7\%$ of their controls had ever had such a violent fight. If we say that number represents the American population, we can compute the normalization factor as $1.19=5.7\%\cdot 4.4 + 94.3\%\cdot 1$, which we can use to compute the following

* If you live in a home where someone has been physically hurt in a fight, the risk of dying from homicide in the home is $0.0025\%\cdot\frac{4.4}{1.19}=$ **0.00924%** (per year)
* If you live in a home where no one has been physically hurt in a fight, the risk of dying from homicide in the home is $0.0025\%\cdot\frac{1.0}{1.19}=$ **0.00210\%** (per year)
* If you don't consider physical violence in your home, the best guess of your risk of dying from homicide in the home is the default **0.0025%** (per year)
</details>

### Combining physical violence and guns.
In the [motivating example](#motivating-example) we talked about the research from @dahlberg2004guns who found that a gun in one's home makes one 1.9 times more likely to be killed in the home. Other research papers have examined the same issue and they were combined in a [meta analysis](#meta-analysis) by @anglemyer2014accessability, where they estimated the risk ratio to be 2.0 - rather than 1.9. Since much more data has been used to estimate the meta analysis estimate, we will use it from now on. 

We want to combine the risk ratio for gun ownership with the results of @kellermann1993gun, who found that a history of domestic physical fights increases the risk of dying from homicide in the home by a factor of 4.4. If one does both, we would want our model to say that the risk is even higher than either, but how much exactly? In this example, and in many others, we have decided that we multiply the risk ratios. We call this multiplicative interaction.

<div class="infobox" id="multiplicativity">
**Multiplicative interaction: ** The interaction between two risk factors is multiplicative when their joint risk ratio is equal to the risk ratio of one risk factor multiplied by the risk ratio of the other risk factor. (In survival analysis and logistic regression, this interaction would be called additive because they consider the effects in log-space).
</div>

In the homicide example multiplicative interaction means:

* If you both live in a household with physical violent fights and gun(s), your risk of dying from homicide in the home is $2.0\cdot 4.4=8.8$ times higher than if you did neither.
* If there is only physical violent fights but no guns, your risk is $4.4$ times higher than if you did neither.
* If there is only guns but no physical violence, your risk is $2.0$ times higher than if you did neither.

We justify this choice by how the odds ratios were computed in the original papers. In @kellermann1993gun they computed the odds ratio $4.4$ using a method that *adjusted for gun ownership*. They assumed that odds ratios for gun ownership, physical violence, race etc. should be multiplied together and then they estimated all odds ratios at once. Consequently, $4.4$ is the most correct odds ratio when multiplied together with the gun ownership odds ratio (and all the other odds ratios in their model). That is good, because that is how we use it! 

However, the odds ratio 2.0 from [@anglemyer2014accessability] was computed from other papers where only some adjusted for physical violence. That should ideally be all the papers now that we multiply the two odds ratios. Fortunately, it doesn't seem to matter that much;

* In @kellermann1993gun they estimated the odds ratio for gun ownership adjusted for physical violence to be 2.6, which is quite near the meta analysis estimate 2.0.
* By combining the studies, the authors @anglemyer2014accessability implicitly assumes that odds ratios adjusted for physical violence are statistically the same as those that are not adjusted. They didn't report any considerations or checks on this assumption (which is not strange because it is not normal in these types of meta analysis), but we can assume that they would have made a different analysis if it had become clear to them that it would be very wrong to combine them.

In general our interactions are multiplicative. The above considerations about how estimates are adjusted repeats many times for the different [death causes](/model#death-causes). It is not always possible to find studies that adjust for every relevant risk factor. In these cases we will often assume that they combine multiplicatively anyway, but the behavior of the program will be more speculative.

### Combining normalization factors
To use the combined risk or odds ratio, we have to compute a new normalizing factor. Let us continue the homicide example where we multiplied the odds ratio for gun ownership (2.0) and physical violence (4.4). 

To compute the normalizing factor we need to know the proportion of Americans who belong to each combination of gun ownership and physical violence. For example we need the proportion of the American population who lives in a household where there is a gun and a history of physical violence. If gun ownership were unrelated to whether there are physical violence, we would say that gun ownership and physical violence are *independent*. 

<div class="infobox" id="independence-definition">
**Independence: ** Two risk factors are independent if they are unrelated in the sense that knowledge of one risk factor doesn't give us any information of the other risk factor and vice-versa. One useful consequence of this is that we can compute the probability that the risk factors have any specific combination of values as the product of 1) the probability that the first factor has its specific value, and 2) the probability that the second factor has its specific factor. See [examples](#independence). 
</div>

This independence assumption means that gun owners and non-gun owners are equally likely to have a violent household. Recall that the proportion of households that owns a gun is $40\%$, and the proportion that has a history of violence is $5.7\%$. Then we could simply compute the joint proportion - the proportion of people who both owns a gun and lives in a violent house - as $40\%\cdot 5.7\%=2.3\%$. It doesn't sound outrageous that gun ownership and physical violence in the home should be independent and since we are unlikely to find the actual joint proportions, we assume that they are independent. Then the normalizing factor is
$$
4.4\cdot 2.0 \cdot 40\% \cdot 5.7\%+4.4\cdot 1.0 \cdot 60\% \cdot 5.7\%+1.0\cdot 2.0 \cdot 40\% \cdot 94.3\% \\+ 1.0\cdot 1.0\cdot 60\%\cdot 94.3\%\approx 1.67
$$
Notice that we could have also gotten $1.67$ by multiplying the two normalization factors of physical violence and gun ownership. That is $1.67=1.19\cdot (60\%+40\%\cdot 2)$. 

We do not always assume independence between risk factors, but it will be handled on a case-by-case and put in the relevant death cause page (See [list](/model#death-causes).

<details><summary>Why assuming incorrect independence is not disastrous</summary>
The potential caveat to assuming that they are independent is that we get a more imprecise estimate of the normalizing factor. On one hand the normalizing factor and in particular, the normalized risk are already uncertain estimates. Considering the homicide example, the normalizing factor when assuming independence was $1.67$. If we don't assume independence but still assume that $5.7\%$ of homes have experienced physical violence and $40\%$ have guns, the lowest possible normalization factor would occur if there were no overlap between the two categories. That is,

$$4.4\cdot 2.0\cdot 0\%+4.4\cdot 1.0 \cdot 5.7\%+1.0\cdot 2.0\cdot 40\%+1.0\cdot 1.0\cdot 54.3\%=1.59.$$
The highest possible normalization factor would happen if there were complete overlap between the two. That is,

$$4.4\cdot 2.0\cdot 5.7\%+4.4\cdot 1.0 \cdot 0\%+1.0\cdot 2.0\cdot 34.3\%+1.0\cdot 1.0\cdot 60\%=1.78.$$

This means that  the normalization factor will always be in the interval (1.59,1.78). For comparison the confidence interval of the 4.4-odds ratio of physical violence is $(2.2,8.8)$ [@kellermann1993gun] and the confidence interval of the 2.0-odds ratio of gun ownership is $(1.56,3.02)$ [@anglemyer2014accessability]. The error from incorrectly assuming independence is therefore not the biggest source of error in this case. In general the independence assumption will matter less when the risk factors are rare or when the risk ratios are similar.  

<!-- Even though the error on the normalized risk may not be important when we don't -->
<!-- have the correct joint proportions, we lose a pleasant property. Correct -->
<!-- proportions would ensure that if all Americans filled out the program and we -->
<!-- averaged all their results, we would get the neutral model. In other words, the -->
<!-- program would be correct on average. The uncertainty in the odds and risk ratios -->
<!-- would still lead to overestimation of, say, some people's risk of dying from -->
<!-- homicide, but with the correct joint proportions some other people's homicide -->
<!-- risk would be correspondingly underestimated. [jeg er ikke sikker på hvorfor det -->
<!-- er en behagelig egenskab?] -->
</details>

### Interaction formulas
Throughout the library we use formulas to communicate the interaction between risk factors. If the interaction between factor A and factor B is [multiplicative](#multiplicativity), we write 

$$
RR=RR_A\cdot RR_B
$$
where $RR_A$ and $RR_B$ are the risk ratio of factor A and B, respectively. The number $RR$ is the joint risk ratio, which we use to compute the risk of dying from the death cause. If the interaction is not multiplicative, we only write

$$
RR=RR_{A,B}.
$$
That doesn't provide a lot of information but it does say that the interaction between A and B is not multiplicative. Also, we put a visualization of $RR_{A,B}$ on the relevant [death cause page](/model#death-causes). 

There can be more than two factors in the formula. For example, the formula could read

$$
RR=RR_A\cdot RR_{B,C}\cdot RR_D.
$$
In this case, there is a multiplicative interaction between 

* factor A,
* the factors B and C, but not between factor B and C,
* factor D.

We also use formulas to show how we compute the proportions of people belonging to every combination of the risk factors because it is needed to calculate the [normalization factor](#normalization-factor). For more than one risk factor, all these proportions together is also called the *joint distribution*. Very similar to the formula for the joint risk ratio, the joint distribution formula only says which factors are *[independent](#independence-definition)*. It could read

$$
P=P_A\cdot P_{B,C,D},
$$
In this situation the factor A is independent of B,C and D, but none of B,C and D are independent with each other. 

## Decomposition
In the previous example we saw that gun-owners have twice as big a probability of dying from homicide in the home compared to non-owners. This means that half of the deaths of gun-owners can be *explained* by gun ownership in the sense that they wouldn't have taken place if the killed persons hadn't owned a gun. To communicate this interesting aspect to the user, we visually *decompose* the bar that represents the probability of dying from a death cause into smaller parts that explains the death. See the example below

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
opt <- par(mfrow=c(1,1), mar=c(1,4,1,1))
layout(matrix(c(1,1,1,1,2,2,2,2), nrow = 4, ncol = 2, byrow = TRUE))
barplot(cbind(c(0.001785,0),
              c(0.003571,0)),
        col = c("white","red"),
        horiz = T, 
        names.arg=c("Non-owner", "Gun owner"),
        axes=F,
        main="Probability of dying from homicide in the home"
        )
barplot(cbind(c(0.001785,0),
              c(0.001785,0.001785)
              ),
        col = c("white","red"),
        horiz = T,
        names.arg=c("Non-owner","Gun owner"),
        legend.text = c("Unexplained","Gun ownership"),
        axes=F,
        main="Decomposed probability of dying from homicide in the home")
par(opt)
```

Be aware that the visualizations of the website only shows the decomposed bar relevant to the user and so users who answer that they don't own a gun will not see any colored bars about gun ownership. 

### Decomposition with two risk factors
If there are two different risk factors, things get more complicated. If we go back to the example about homicide in the home, gun ownership and domestic violence, the non-decomposed probabilities would look like this

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
layout(matrix(c(1,1,1,1),2,2))
opt <- par(mar=c(1,4,1,1))
b <- barplot(rev(c(1,2,4.4,8.8)),
        col = c("white"),
        horiz = T, 
        axes=F,
        main="Probability of dying from homicide in the home"
        )
first=rev(rep(c("Non-owner","Gun owner"),2))
second=rev(rep(c("No dom. violence","Dom. violence"),each=2))
mtext(first, side=2, line=1, at=b, cex=0.7)
mtext(second, side=2, line=2, at=b, cex=0.7)
par(opt)
```

We could decompose each of them as before

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
layout(matrix(c(1,1,1,1),2,2))
opt <- par(mar=c(1,4,1,1))
b <- barplot(cbind(c(1,0,0,7.8),
                   c(1,0,3.4,0),
                   c(1,1,0,0),
                   c(1,0,0,0)),
        col = c("white","red","lightblue","black"),
        horiz = T, 
        axes=F,
        main="Decomposed probability of dying from homicide in the home, simple",
        legend.text = c("Unexplained", "Gun ownership","Domestic violence","Gun AND violence in home")
        )
first=rev(rep(c("Non-owner","Gun owner"),2))
second=rev(rep(c("No dom. violence","Dom. violence"),each=2))
mtext(first, side=2, line=1, at=b, cex=0.7)
mtext(second, side=2, line=2, at=b, cex=0.7)
par(opt)
```

While the "domestic violence AND gun owner" is correct, it doesn't say anything that lets the user distinguish between the effect of domestic violence and gun ownership. Therefore, we decompose that section further. When comparing the "domestic violence, no gun" bar to the "domestic violence, gun owner" bar, we can see that the gun owner factor doubles the risk, and so we could argue that the gun owner section should constitute half of the risk for the group "domestic violence, gun owner". We call this approach Gun owner-*centered* because it computes the gun owner risk increase last. A domestic violence centered decomposition will look differently as shown below.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
layout(matrix(c(1,1,2,2),2,2, byrow=T))
opt <- par(mar=c(1,4,1,1))
b <- barplot(cbind(c(1,1,6.8)),
        col = c("white","red","lightblue"),
        horiz = T, 
        axes=F,
        main="Decomposed probability, Domestic violence centered",
        legend.text = c("Unexplained", "Gun ownership","Domestic violence"))
mtext("Gun owner", side=2, line=1, at=b, cex=0.7)
mtext("Dom. violence", side=2, line=2, at=b, cex=0.7)
b <- barplot(cbind(c(1,3.4,4.4)),
        col = c("white","lightblue","red"),
        horiz = T, 
        axes=F,
        main="Decomposed probability, Gun ownership centered",
        legend.text = c("Unexplained","Domestic violence", "Gun ownership"))
mtext("Gun owner", side=2, line=1, at=b, cex=0.7)
mtext("Dom. violence", side=2, line=2, at=b, cex=0.7)
par(opt)
```

In the domestic violence centered decomposed probability, the interpretation of the two sections are

* The size of the Gun ownership section is the risk increase when owning a gun *given that there is no domestic violence*
* The size of the Domestic violence section is the risk increase when living in a violent household *given that there is a gun*

In the Gun ownership centered decomposed probability, it is opposite;

* The size of the Gun ownership section is the risk increase when owning a gun *given that there is domestic violence*
* The size of the Domestic violence section is the risk increase when living in a violent household *given that there is a no gun*

So how do we actually compute the decomposed probability? Gun ownership centered or domestic violence centered? And how do we handle this in general? The answer is that we make the decomposition centered around the factors that are easier to *optimize*. For example in skin cancer, there are two main factors; your race and your sun exposure. It is clearly not possible to change your race, but you can change your (future) sun exposure. Therefore we decompose skin cancer centered on sun exposure. For domestic violence and gun ownership, it is a bit harder to judge which is easier to optimize. Both can be changed by moving which, in theory, can be done tomorrow. They are tied in our [optimizability ranking](/model/optimizabilities#optimizability), and we therefore use another decomposition strategy.

#### Decomposing two equally optimizable factors

When two factors are equally optimizable, we don't center the decomposition on  either factor. Instead, we divide the *extra* risk equally between them. Consider the example with gun ownership, domestic violence and their relation to homicide in the home and say that we want to decompose the probability for the group that both owns a gun and has a violent household. By comparing those with neither violence nor guns to those with guns, we can get the risk increase from purely guns, and likewise we can obtain the risk increase for purely domestic violence. If we add these pure risk increases, it doesn't add up to the risk increase when comparing those with neither guns nor violence to those with both guns and violence. It is surely better illustrated graphically;

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
layout(matrix(c(1,1,1,1,1,1,2,2),4,2, byrow=T))
opt <- par(mar=c(1,4,1,1))
b <- barplot(cbind(c(1,0,3.4,0),
                   c(1,1,0,0),
                   c(1,0,0,0)),
        col = c("white","red","lightblue","black"),
        horiz = T, 
        axes=F,
        main="Decomposed probability of dying from homicide in the home, middle stage",
        legend.text = c("Unexplained", "Gun ownership"),
        xlim = c(0,8.8)
        )
first=rev(rep(c("Non-owner","Gun owner"),2))[-4]
second=rev(rep(c("No dom. violence","Dom. violence"),each=2))[-4]
mtext(first, side=2, line=1, at=b, cex=0.7)
mtext(second, side=2, line=2, at=b, cex=0.7)
b <- barplot(cbind(c(1,1,3.4,3.4)),
        col = c("white","red","lightblue","black"),
        horiz = T, 
        axes=F,
        main="Decomposed probability of dying from homicide in the home, unassigned extra",
        legend.text = c("Unexplained", "Gun ownership", "Domestic violence", "Extra"))
mtext("Gun owner", side=2, line=1, at=b, cex=0.7)
mtext("Dom. violence", side=2, line=2, at=b, cex=0.7)
par(opt)
```

The extra part can be interpreted as the risk increase that arises from the combination of domestic violence and gun ownership. Gun ownership and domestic violence are bad by themselves, but the combination is worse than the sum of them. In a Gun ownership centered decomposition, we would assign the extra part to the "Gun ownership" category and in a Domestic violence centered decomposition, we would assign the extra part to the "Domestic ownership" category. However, as we don't prioritize one over the other, it is shared equally.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
layout(matrix(c(1,1,2,2),2,2, byrow=T))
opt <- par(mar=c(1,4,1,1))
b <- barplot(cbind(c(1,1,3.4,1.7,1.7)),
        col = c("white","red","lightblue","red","lightblue"),
        horiz = T, 
        axes=F,
        main="Decomposed probability of dying from homicide in the home, unsorted",
        legend.text = c("Unexplained", "Gun ownership", "Domestic violence"),
        )
mtext("Gun owner", side=2, line=1, at=b, cex=0.7)
mtext("Dom. violence", side=2, line=2, at=b, cex=0.7)
b <- barplot(cbind(c(1,2.7,5.1)),
        col = c("white","red","lightblue"),
        horiz = T, 
        axes=F,
        main="Decomposed probability of dying from homicide in the home, final",
        legend.text = c("Unexplained", "Gun ownership", "Domestic violence"),
        )
mtext("Gun owner", side=2, line=1, at=b, cex=0.7)
mtext("Dom. violence", side=2, line=2, at=b, cex=0.7)
par(opt)
```

Though it rarely happens, be aware that the extra part can be negative. It may occur when two factors are similar or measuring the same effect. In this case the negative extra part is subtracted equally among the two risk factors.

### Decomposition of $n$ factors

Decomposition of a risk with $n$ risk factors is not very different from decomposition of a risk with 2 risk factors. Instead of only centering on the factor with highest [optimizability](/model/optimizabilities), we make scheme where we consecutively center on the with second-lowest optimizability, third-lowest optimizability and so on until the highest optimizable factor. Ties in optimizability can also be resolved in a similar way (see below).

<details><summary>Algorithm and relation to other methods</summary>
Let $F_1, \dots, F_n$ be the $n$ factors (and random variables). Let $\psi_1, \dots, \psi_n$ be the user's $n$ values on the $n$ factors. Now let $U(I)$, $I\subseteq \{1, \dots, n\}$ be the smallest risk possible that satisfy

$$
F_i=\psi_i \text{ for all } i\in I.
$$

Define recursively for a set $K\subseteq \{1, \dots, n\}$,$I\subseteq \{1, \dots, n\}\setminus K$

$$
S(\emptyset| K)=U(K)\\
S(I|K)=U(I\cup K)-\sum_{J\subset I, J\neq I} S(J|K), \quad \text{for } |I|>0
$$

For $I=\{i\}$, we can interpret $S(I|\emptyset)$ as the pure contribution of factor $i$. For $|I|=2$, $S(I|\emptyset)$ can be interpreted as the "extra part" discussed in the previous section. For $|I|>2$ the interpretation is more complex but it will still be some "extra part" to make the sum of all the previous factors add up. 

For $|K|>0$, the quantity $S(I|K)$ should be interpreted in the same way as $S(I|\emptyset)$ but with the extra condition that it is conditioned on the factors $F_k, k\in K$.

Let $J_1, \dots, J_m\subseteq \{1, \dots, n\}$ be disjoint sets such that the set $J_i$ contains the indices of all factors that share the $i$'th lowest optimizability.

Then, we compute the total risk increase associated with factor $i$ using the formula

$$
V(i)=\sum_{I\subseteq J_1, i\in I} \frac{S(I|\emptyset)}{|I|} \quad \text{if } i\in J_1\\
V(i)=\sum_{I\subseteq J_k, k\in I} \frac{S(I|J_1 \cup \cdots \cup J_{k-1})}{|I|} \quad \text{if } i\in J_k, k>1
$$

Our decomposition method can also be seen as a modified version of the multi-risk factor attributable risk proposed by @eide1995sequential. Their method attributes says how responsible a risk factor is for a general population, and not just for a single individual as we do. On the other hand, they do not rank the risk factors according to their optimizability. For a fixed optimizability our decomposition method is a special case of the method by @eide1995sequential where the population is just a single individual. 

</details>


### Optimal values

In order to know how much risk can be prevented by optimizing a single [risk factor](#risk-factor), we need to know the optimal value of that risk factor. Only then can we compare the risk of the user to the lowest possible risk and communicate this difference in the [decomposition](#decomposition) described in the previous section. 

It is not always as easy to compute the optimal value as in the example with homicide in the home, gun ownership and domestic violence. In that example there were only four different risks corresponding to the four combinations of gun ownership and domestic violence and so we could easily see that in all cases it was better to not own a gun and better to not have domestic violence. Things that complicate the calculation of optimal values are

* [Smoothing](#smoothing). When smoothing, we compute the risks from a continuous curve which means that there are infinitely many different risks. In these cases we compute the optimal values using differential calculus.
* Non-multiplicative [interactions](#interaction) between risk factors. When two factors don't have a [multiplicative](#multiplicativity) interaction, the optimal value of one risk factor can depend on the value of the other. An example can be seen in [Liver cancer: BMI-HCV diagnosis](/model/LiverCancer#bmi-hcv-diagnosis), where a high BMI is only dangerous if one has hepatitis C. The optimal BMI when conditioning on a positive HCV diagnosis is 18, but in general the optimal BMI can be anything as long as one doesn't have hepatitis.
* Age effects. If the risk ratios of a risk factor depends on age, the optimal value may also depend on age. Likewise, if the risk factor itself depends on age. 
* Different sub death causes. If a risk factor appears in more than one death cause, it can have different optimal value in them. For example, biological sex is a risk factor in both breast cancer and prostate cancer, where the optimal value is female and male, respectively. When considering all cancers at once, the optimal value of biological sex is therefore both male and female.

# Glossary

#### Dose-response
A dose-response is a special type of analysis that are often made when considering just one [risk factor](#risk-factor) that can be infinitely many different numbers. This numeric risk factor is the dose. For example, the dose could be the number of alcohol drinks per week, because it can be 0, 10, 3.4, 0.02, etc.  The response is most often risk ratio, odds ratio or similar. The dose-response relationship is often presented using binned dose-intervals like the example we saw in section [Smoothing](#smoothing).

#### Independence
Variables are independent, when there is absolutely no relation between them. This is equivalent to saying that if you know one (or some) of the variables, you are not any wiser about the other variables. One example is two consecutive die rolls. The result of the first die roll, doesn't tell you anything about the result of the second, so they are independent. [Risk factors](#risk-factor), on the other hand, are rarely completely independent. Consider for example sex and eye color. At first they may seem independent, but remember that 

* The proportions of different eye colors changes from country to country.
* The ratio between males and females also depends on the country

Imagine that we draw a random person in the world and we only know that he or she has brown eyes. With this tiny bit of information, we know that the person is more likely to come from a country with many brown-eyed people, and because the countries with many brown-eyed people generally have more males than females, we should now think there is a higher change that the person is male. This means that the person's eye color affected our expectation of their sex, and so eye color and sex is not independent. It didn't change our expectation by a lot, so we would say that they are almost independent. 

The benefit of independent variables is that it makes computations easier and faster. We will therefore assume risk factors are independent when it is not too wrong (see considerations in Section [Combining normalization factors](#combining-normalization-factors)).

#### Meta analysis
In health research the same risk ratios, odds ratios or similar are often estimated in many different studies that varies by location and methods. The meta analysis finds these studies, removes those with unwanted methodology, and takes a kind of average of all the estimates. This averaged estimate will normally have a smaller error than any of the original estimates. A downside is that is much harder to determine the methodology behind the averaged estimate, because it will be some combination of methodology of all the included studies.

#### Odds ratio
An odds ratio is two odds divided by each other. In this document, an odds is a probability divided by the complementary probability. That is, if the probability is $p=0.2=20\%$, the odds is
$$
\frac{p}{1-p}=\frac{0.2}{1-0.2}=\frac{1}{4}=25\%
$$

An odds ratio is then
$$
OR=\frac{\frac{p_1}{1-p_1}}{\frac{p_2}{1-p_2}}
$$

We will almost consequently make the approximation
$$
OR=\frac{\frac{p_1}{1-p_1}}{\frac{p_2}{1-p_2}}\approx \frac{p_1}{p_2}=RR
$$
which is justified when $p_1$ and $p_2$ are small or close to each other. The RR is notation for [Risk Ratio](#risk-ratio) 

#### Probability
See [Risk](#risk).

#### Risk
Risk is the same as probability. It represents the certainty of some event (which could be dying from homicide). It is a number between $0\%=0$ and $100\%=1$, where $0\%$ means that the event will definitely not happen and $100\%$ means that it definitely will.

#### Risk factor
A risk factor is a variable that affects a risk. For example, physical activity is a risk factor *for* colorectal cancer because one's risk of dying from colorectal cancer depends on one's level of physical activity. 

#### Risk ratio

A risk ratio is two probabilities divided by each other. Risk ratios normally occur in studies where some people have been divided into different categories that have different risks of something. If there are 3 categories, there are 3 risks $p_1, p_2$ and $p_3$. If category number one is the *base category*, the risk ratios are computed as
$$
\text{RR}_1=\frac{p_1}{p_1}, \, \text{RR}_2=\frac{p_2}{p_1}, \, \text{RR}_3=\frac{p_3}{p_1} 
$$

Notice that $\text{RR}_1$ will always be $1.0$ using this definition. 


# References
